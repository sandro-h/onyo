<!DOCTYPE html>
<html lang="en">

<head>
    <title>{{ category.name }} - Onyo</title>
    {% include "_preamble.html" %}
    <style type="text/css">
        .icon-l {
            float: left;
            opacity: 0.6;
        }

        .icon-r {
            float: right;
            opacity: 0.6;
        }

        .detail {
            color: lightgray;
            font-size: 75%;
        }

        #search {
            width: 80%;
            margin-top: 1em;
            margin-left: 1em;
        }
    </style>
    <script type="text/javascript">
        function main() {
            let lastPick = -1;
            const randomBtn = document.getElementById('random-btn');
            const allBtn = document.getElementById('all-btn');
            const meals = document.querySelectorAll('section li');

            randomBtn.addEventListener('click', pickRandom);
            allBtn.addEventListener('click', showAll);

            function pickRandom() {
                lastPick = randomIndex(meals.length, lastPick);
                meals.forEach((m, i) => i === lastPick ? show(m) : hide(m));
                show(allBtn);
            }

            function showAll() {
                meals.forEach(show);
                hide(allBtn);
            }

            initSearch();
        }

        function randomIndex(count, last) {
            for (; ;) {
                const pick = Math.floor(Math.random() * count);
                if (pick !== last || count === 1) {
                    return pick;
                }
            }
        }

        function initSearch() {
            const search = document.getElementById('search');
            search.addEventListener('input', () => {
                let term = search.value.toLowerCase();
                const searchForIngredients = term.startsWith('i:');
                if (searchForIngredients) {
                    term = term.substring(2);
                }

                document.querySelectorAll('.recipe').forEach(e => {
                    const haystack = searchForIngredients ? e.dataset.searchingredients : e.dataset.searchname
                    const matches = haystack.toLowerCase().includes(term);
                    if (matches) {
                        show(e);
                    }
                    else {
                        hide(e);
                    }
                });
            });
        }

        function hide(e) {
            e.classList.add('hidden');
        }

        function show(e) {
            e.classList.remove('hidden');
        }

        document.addEventListener('DOMContentLoaded', main);
    </script>
</head>

<body>
    <main>
        <nav>
            <h1><a href="/onyo">&#9001; {{ category.name }} <span class="detail">({{ category.recipes | length }})</span></a></h1>
            <a id="all-btn" class="btn hidden" href="#">Show all</a>
            <a id="random-btn" class="btn" href="#">Random</a>
        </nav>
        <section>
            <input id="search" type="search" autocomplete="off" placeholder="Search recipe. i:[name] search by ingredient"/>
            <ul>
                {% for recipe in category.recipes %}
                <li>
                    <a class="btn recipe" href="/onyo/recipes/{{recipe.id}}" data-searchname="{{ recipe.name }}" data-searchingredients="{{ recipe.searchable_ingredients() | join('|') }}">
                        <span class="icon-l">{{recipe.icon}}</span>
                        <span>{{recipe.name}}</span>
                        <span class="icon-r">{{recipe.icon}}</span>
                    </a>
                </li>
                {% endfor %}
            </ul>
        </section>
    </main>
</body>

</html>