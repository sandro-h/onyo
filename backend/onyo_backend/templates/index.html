<!DOCTYPE html>
<html lang="en">

<head>
    <title>Onyo</title>
    {% include "_preamble.html" %}
    <style type="text/css">
        .title-onyo {
            width: 20px;
            height: 20px;
        }
        .user {
            font-style: italic;
            color: lightgray;
        }
        section {
            text-align: center;
        }

        ul {
            padding-left: 1em;
        }

        li {
            list-style-type: none;
        }

        .special-btn {
            background-color: #9a0dfa !important;
        }

        #search {
            width: 80%;
            margin-top: 1em;
            margin-left: 1em;
        }

        .hidden {
            display: none;
        }
    </style>
    <script type="text/javascript">
        function main() {
            initSearch();
            const addRecipeBtn = document.getElementById('add-recipe-btn');
            addRecipeBtn.addEventListener('click', addRecipe);
        }

        function initSearch() {
            const search = document.getElementById('search');
            const categories = document.getElementById('categories');
            const results = document.getElementById('results');
            search.addEventListener('input', () => {
                let term = search.value.toLowerCase();
                const searchForIngredients = term.startsWith('i:');
                if (searchForIngredients) {
                    term = term.substring(2);
                }


                if (!term) {
                    show(categories);
                    hide(results);
                }
                else {
                    show(results);
                    hide(categories);
                }

                document.querySelectorAll('.recipe').forEach(e => {
                    const haystack = searchForIngredients ? e.dataset.searchingredients : e.dataset.searchname
                    const matches = haystack.toLowerCase().includes(term);
                    if (matches) {
                        show(e);
                    }
                    else {
                        hide(e);
                    }
                });
            });
        }

        function hide(e) {
            e.classList.add('hidden');
        }

        function show(e) {
            e.classList.remove('hidden');
        }

        function addRecipe() {
            const name = prompt("Recipe name");
            if (!name) {
                return;
            }
            document.getElementById('add-recipe-name').value = name;
            document.getElementById('form').submit();
        }

        document.addEventListener('DOMContentLoaded', main);
    </script>
</head>

<body>
    <main>
        <nav>
            <h1>
                <img class="title-onyo" src="/onyo/static/logo192.png">
                Onyo
            </h1>
            <span class="user">
                {{ user.name or 'anonymous' }}
            </span>
        </nav>
        <section>
            <input id="search" type="search" autocomplete="off" placeholder="Search recipe. i:[name] search by ingredient"/>
            <ul id="categories">
                {% for cat in categories.values()|sort(attribute='name') %}
                <li><a class="link-btn" href="/onyo/categories/{{cat.name}}">{{cat.name}}</a></li>
                {% endfor %}
                <li><a class="link-btn special-btn" href="/onyo/ideas">ðŸ’¡ Ideas</a></li>
                {% if 'recipe_editor' in user.roles %}
                <form id="form" method="POST" action="/onyo/recipes">
                    <li><a id="add-recipe-btn" class="link-btn special-btn" href="#">New recipe</a></li>
                    <input id="add-recipe-name" name="name" type="hidden" />
                </form>
                {% endif %}
            </ul>
            <ul id="results" class="hidden">
                {% for recipe in recipes %}
                <li>
                    <a class="link-btn recipe" href="/onyo/recipes/{{recipe.id}}" data-searchname="{{ recipe.name }}" data-searchingredients="{{ recipe.searchable_ingredients() | join('|') }}">
                        <span class="icon-l">{{recipe.icon}}</span>
                        <span>{{recipe.name}}</span>
                        <span class="icon-r">{{recipe.icon}}</span>
                    </a>
                </li>
                {% endfor %}
            </ul>
        </section>
    </main>
</body>

</html>