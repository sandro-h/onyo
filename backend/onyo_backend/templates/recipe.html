<!DOCTYPE html>
<html lang="en">

<head>
    <title>{{ recipe.name }} - Onyo</title>
    {% include "_preamble.html" %}
    <style type="text/css">
        .tab {
            display: none;
        }

        .tab.visible {
            display: flex;
            flex-grow: 1;
            flex-direction: column;
            padding-left: 0.5em;
            padding-right: 0.5em;
        }

        nav.top-nav {
            display: flex;
            flex-direction: row;
            align-items: center;
        }

        nav.top-nav>h1 {
            flex-grow: 1;
        }

        nav.sub-nav {
            display: flex;
            justify-content: space-between;
            border-bottom: solid 2px lightgray;
        }

        .switcher {
            cursor: pointer;
            /* min-width: 100%; */
            width: 100%;
            text-align: center;
            padding-top: 1em;
            padding-bottom: 1em;
            color: gray;
            position: relative;
        }

        .switcher.selected {
            color: black;
            font-weight: bold;
            border-bottom: solid 2px rgb(0, 105, 170);
        }

        .switcher-subtitle {
            position: absolute;
            width: 100%;
            font-size: 75%;
            overflow: hidden;
            text-overflow: ellipsis;
            text-wrap: nowrap;
        }

        .ingredients {
            padding-top: 0.5em;
        }

        ol,
        ul {
            margin-top: 4px;
            margin-bottom: 4px;
            padding-left: 1em;
        }

        li {
            padding-bottom: 0.5em;
        }

        .ingredients li {
            list-style-position: inside;
        }

        /* to put ingredients at bottom of screen */
        /* section {
             flex: 1; 
        } */

        footer {
            width: 100%;
            text-align: center;
            border-top: solid 1px gray;
        }

        .timer>a {
            color: rgb(57, 57, 245);
            font-weight: bold;
        }

        .timer::after {
            content: '\1F551';
            font-size: 70%;
            vertical-align: super;
            text-decoration: none;
        }

        .step_ingredients {
            display: inline-block;
            line-height: 1.2em;
        }

        .mise {
            border-left-style: solid;
            border-left-width: 2px;
            border-radius: 0.5em;
            display: inline-block;
            color: black;
        }

        .mise-in-step {
            border-left-color: gray;
        }

        .ingredients .mise {
            padding-left: 0.5em;
            margin-left: calc(-0.5em - 2px);
            display: block;
        }

        .ingr {
            font-weight: bold;
        }

        .step-ingr {
            font-weight: bold;
            padding-left: 1em;
            padding-right: 1em;
        }

        .task {
            cursor: pointer;
        }

        .step-ingr.selected {
            background: rgba(255, 217, 12, 0.44);
            border-radius: 4px;
        }

        .bold {
            font-weight: bold;
        }

        #shopping-list {
            display: none;
            white-space: pre;
            overflow-wrap: normal;
            overflow-x: scroll;
        }

        h4 {
            margin-top: 0.5em;
            margin-bottom: 0px;
            text-align: center;
        }
    </style>
    <script type="text/javascript">

        function main() {
            let curTabIndex = 0;
            const tabs = document.querySelectorAll('.tab');
            const switchers = document.querySelectorAll('.switcher');
            const shoppingListBtn = document.getElementById('shopping-list-btn');
            const tabCount = tabs.length;

            document.querySelectorAll('.switcher').forEach(e => e.addEventListener('click', () => handleSwitcherClick(e)));
            shoppingListBtn.addEventListener('click', copyShoppingList);

            document.addEventListener('touchstart', handleTouchStart, false);
            document.addEventListener('touchend', handleTouchStop, false);
            document.addEventListener('touchcancel', handleTouchStop, false);
            document.addEventListener('touchmove', handleTouchMove(left => {
                const index = Math.min(tabCount - 1, Math.max(0, curTabIndex + (left ? -1 : 1)));
                selectTab(index);
            }), false);

            document.querySelectorAll('.task').forEach(e => e.addEventListener('click', () => handleTaskClick(e)));

            function handleSwitcherClick(switcher) {
                selectTab(parseInt(switcher.dataset.tab));
            }

            function selectTab(indexToSelect) {
                tabs[curTabIndex].classList.remove('visible');
                switchers[curTabIndex].classList.remove('selected');
                tabs[indexToSelect].classList.add('visible');
                switchers[indexToSelect].classList.add('selected');
                curTabIndex = indexToSelect;
            }

            function handleTouchStart(ev) {
                const touches = ev.touches || ev.originalEvent.touches;
                window.firstTouchX = touches[0].clientX;
                window.firstTouchY = touches[0].clientY;
                window.touchTriggered = false;
            }

            function handleTouchStop() {
                window.touchTriggered = false;
                window.firstTouchX = 0;
                window.firstTouchY = 0;
            }

            function handleTouchMove(callback) {
                return function handle(ev) {
                    if (window.touchTriggered) {
                        return;
                    }
                    const triggerRatio = 0.25;
                    const x = ev.touches[0].clientX;
                    const y = ev.touches[0].clientY;
                    const dx = x - window.firstTouchX;
                    const dy = y - window.firstTouchY;

                    // Note: comparing dy to innerWidth is on purpose
                    if (dx / window.innerWidth > triggerRatio && Math.abs(dy / window.innerWidth) < 0.1) {
                        callback(true);
                        window.touchTriggered = true;
                    }
                    else if (dx / window.innerWidth < -triggerRatio && Math.abs(dy / window.innerWidth) < 0.1) {
                        callback(false);
                        window.touchTriggered = true;
                    }
                };
            }

            function handleTaskClick(task) {
                const taskIngredientIndices = task.dataset.ingredientIndices.split(',');
                if (!taskIngredientIndices) {
                    return;
                }

                const stepIngredients = document.querySelectorAll('.tab.visible .step-ingr');                
                stepIngredients.forEach((ingr, index) => {
                    const usedInTask = taskIngredientIndices.includes(index + '');
                    if (usedInTask) {
                        ingr.classList.toggle('selected');
                    }
                    else {
                        ingr.classList.remove('selected');
                    }
                });
            }

            function copyShoppingList() {
                const shoppingListText = document.getElementById("shopping-list").value
                navigator.clipboard.writeText(shoppingListText);
            }
        }

        document.addEventListener('DOMContentLoaded', main);
    </script>
</head>

<body>
    <main>
        <nav class="top-nav">
            <h1><a href="{{back_link}}">&#9001; {{ recipe.name }}</a></h1>
            {% if 'recipe_editor' in user.roles %}
            <a class="control-btn" href="{{ link }}/edit">✏️</a>
            {% endif %}
            <a id="shopping-list-btn" class="control-btn" href="#">Shopping list</a>
        </nav>


        <nav class="sub-nav">
            <div class="switcher selected" data-tab="0">Ingr</div>
            {% for step in recipe.steps %}
            <div class="switcher" data-tab="{{loop.index}}">
                <div>{{loop.index}}</div>
                <div class="switcher-subtitle">{{ step.title }}</div>
            </div>
            {% endfor %}
        </nav>

        <div class="tab visible ingredients">
            {% set mise_index = namespace(value=0) %}
            {% for group in recipe.ingredient_groups %}
            <h4>{{ group.title }}</h4>
            <ul>
                {% for ingr in group.ingredients %}
                    {% if ingr.mise == Mise.START %}
                        <div class="mise col{{mise_index.value % NUM_COLORS}}">
                        {% set mise_index.value = mise_index.value + 1 %}
                    {% endif %}
                    <li>
                        {% if ingr.linked_recipe_id %}
                            <a href="/onyo/recipes/{{ ingr.linked_recipe_id }}">{{ ingr.text }}</a>
                        {%else %}
                            {{ ingr.text }}
                        {% endif %}
                    </li>
                    {% if ingr.mise == Mise.END %}
                        </div>
                    {% endif %}
                {% endfor %}
            </ul>
            {% endfor %}
            
            {% if recipe.notes %}
            <h4>Notes</h4>
            {% for note in recipe.notes %}
            <li>
                {%- for part in note.parts -%}
                    {%- if part.type == "text" -%}
                        <span class="{{ part.style }}">{{- part.text -}}</span>
                    {%- endif -%}
                {%- endfor -%}
            </li>
            {% endfor %}
            {% endif %}

            <textarea id="shopping-list">
{%- for item in shopping_list.items %}
{{ item.link }} {{ item.text }}
{%- endfor -%}
            </textarea>
        </div>

        {% for step in recipe.steps %}
        <div class="tab">
            <section>
                <ol>
                    {% for task in step.tasks %}
                    <li class="task" data-ingredient-indices="{{ task.ingredient_indices() | join(',') }}">
                        {%- for part in task.parts -%}
                            {%- if part.type == "text" -%}
                                <span class="{{ part.style }}">{{- part.text -}}</span>
                            {%- elif part.type == "ingredient" -%}
                                <span class="ingr col{{ part.ingr_index_in_step % NUM_COLORS }}">{{ part.text }}</span>
                            {%- elif part.type == "timer" -%}
                                <span class="timer"><a href="launchtimer://?seconds={{ part.seconds }}&title={{ recipe.name }}">{{ part.text }}</a></span>
                            {%- endif -%}
                        {%- endfor -%}
                    </li>
                    {% endfor %}
                </ol>
            </section>
            {% if step.ingredients %}
            <footer>
                <div class="step_ingredients">
                    {% for ingr in step.ingredients %}
                    <br />
                    {% if ingr.mise == Mise.START %}
                    <div class="mise mise-in-step">
                        {% endif %}
                        <span class="step-ingr col{{loop.index0 % NUM_COLORS}}">{{ ingr.text }}</span>
                        {% if ingr.mise == Mise.END %}
                    </div>
                    {% endif %}
                    {% endfor %}
                </div>
            </footer>
            {% endif %}
        </div>
        {% endfor %}
    </main>
</body>

</html>